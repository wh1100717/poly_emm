// Generated by CoffeeScript 1.7.1
var root;

root = typeof exports !== "undefined" && exports !== null ? exports : this;

$(function() {
  $('#app-list').dataTable({
    "oLanguage": {
      "sLengthMenu": "每页显示 _MENU_ 条记录",
      "sInfo": "从 _START_ 到 _END_ /共 _TOTAL_ 条数据",
      "sInfoEmpty": "&nbsp;",
      "sInfoFiltered": "(从 _MAX_ 条数据中检索)",
      "oPaginate": {
        "sFirst": "首页",
        "sPrevious": "前一页",
        "sNext": "后一页",
        "sLast": "尾页"
      },
      "sSearch": "搜索: ",
      "sZeroRecords": "没有检索到数据",
      "sProcessing": "<img src='./loading.gif' />"
    }
  });
  return $.ajax({
    "type": "get",
    "url": "apps",
    "success": function(data) {
      var d, data_list, table_data, tmp, _i, _len;
      console.log(data);
      data_list = data['data'];
      table_data = [];
      for (_i = 0, _len = data_list.length; _i < _len; _i++) {
        d = data_list[_i];
        tmp = [];
        tmp.push(d['app_id']);
        tmp.push(d['app_name']);
        tmp.push(d['time']);
        tmp.push("<button type='button' class='btn btn-xs btn-success btn-confirm' data-toggle='modal' data-target='#app-delete' onclick='app_delete(\"" + d['app_id'] + "\")'>删除</button><button type='button' class='btn btn-xs btn-success' data-toggle='modal' data-target='#app-pull' onclick='app_pull(\"" + d['app_id'] + "\")'>推送</button>");
        table_data.push(tmp);
      }
      $("#app-list").dataTable().fnAddData(table_data);
      $('[data-rel=tooltip]').tooltip({
        'html': true
      });
      $(".btn-confirm").confirm({
        text: "是否删除该应用",
        title: "删除应用",
        confirm: function(button) {
          $('#app-delete').val(app_id);
          $.ajax({
            "type": "delete",
            "contentType": "application/json",
            "url": "/apps/" + app_id,
            "success": function(resp) {
              if (resp.status === 1) {
                return alert('删除成功');
              }
            }
          });
          return show_page('app_list', '推送应用');
        },
        cancel: function(button) {
          return alert('no');
        },
        confirmButton: "确定",
        cancelButton: "取消"
      });
    }
  });
});

this.app_pull = function() {
  $('#device-list').dataTable({
    "bRetrieve": true,
    "bDestroy": true,
    "oLanguage": {
      "sLengthMenu": "每页显示 _MENU_ 条记录",
      "sInfo": "从 _START_ 到 _END_ /共 _TOTAL_ 条数据",
      "sInfoEmpty": "&nbsp;",
      "sInfoFiltered": "(从 _MAX_ 条数据中检索)",
      "oPaginate": {
        "sFirst": "首页",
        "sPrevious": "前一页",
        "sNext": "后一页",
        "sLast": "尾页"
      },
      "sSearch": "搜索: ",
      "sZeroRecords": "没有检索到数据",
      "sProcessing": "<img src='./loading.gif' />"
    }
  });
  $("#device-list").dataTable().fnClearTable();
  return $.ajax({
    "type": "get",
    "url": "devices",
    "success": function(data) {
      var d, data_list, table_data, tmp, _i, _len;
      console.log(data);
      data_list = data['data'];
      table_data = [];
      for (_i = 0, _len = data_list.length; _i < _len; _i++) {
        d = data_list[_i];
        tmp = [];
        tmp.push("<input type=\"checkbox\" name=\"chek_list\" value=\"1\">");
        tmp.push(d['owner']);
        tmp.push(d['phone']);
        table_data.push(tmp);
      }
      $("#device-list").dataTable().fnAddData(table_data);
      $('[data-rel=tooltip]').tooltip({
        'html': true
      });
    }
  });
};

this.app_upload = function() {
  return $('#app-upload-form').ajaxSubmit(function(data) {
    if (data.status === 1) {
      alert('upload成功');
    }
    $('#app-upload').on('hidden.bs.modal', function() {
      return show_page('html_app', '推送应用');
    });
    return $('#app-upload').modal('hide');
  });
};

this.app_delete = function(app_id) {
  return root.app_id = app_id;
};
