// Generated by CoffeeScript 1.7.1
var root;

root = typeof exports !== "undefined" && exports !== null ? exports : this;

$(function() {
  $('#doc-list').dataTable({
    "oLanguage": {
      "sLengthMenu": "每页显示 _MENU_ 条记录",
      "sInfo": "从 _START_ 到 _END_ /共 _TOTAL_ 条数据",
      "sInfoEmpty": "&nbsp;",
      "sInfoFiltered": "(从 _MAX_ 条数据中检索)",
      "oPaginate": {
        "sFirst": "首页",
        "sPrevious": "前一页",
        "sNext": "后一页",
        "sLast": "尾页"
      },
      "sSearch": "搜索: ",
      "sZeroRecords": "没有检索到数据",
      "sProcessing": "<img src='./loading.gif' />"
    }
  });
  return $.ajax({
    "type": "get",
    "url": "docs",
    "success": function(data) {
      var d, data_list, table_data, tmp, _i, _len;
      console.log(data);
      data_list = data['data'];
      table_data = [];
      for (_i = 0, _len = data_list.length; _i < _len; _i++) {
        d = data_list[_i];
        tmp = [];
        tmp.push(d['doc_id']);
        tmp.push(d['doc_name']);
        tmp.push(d['time']);
        tmp.push("<button type='button' class='btn btn-xs btn-info' data-toggle='modal' data-target='#doc-pull' onclick='doc_pull(\"" + d['doc_id'] + "\")'>推送</button><button type='button' class='btn btn-xs btn-danger btn-confirm' data-toggle='modal' data-target='#doc-delete' onclick='doc_delete(\"" + d['doc_id'] + "\")'>删除</button>");
        table_data.push(tmp);
      }
      $("#doc-list").dataTable().fnAddData(table_data);
      $('[data-rel=tooltip]').tooltip({
        'html': true
      });
      $(".btn-confirm").confirm({
        text: "确认删除该文档？",
        title: "删除文档",
        confirm: function(button) {
          $('#doc-delete').val(doc_id);
          $.ajax({
            "type": "delete",
            "contentType": "application/json",
            "url": "/docs/" + doc_id,
            "success": function(resp) {
              if (resp.status === 1) {
                return alert('删除成功');
              }
            }
          });
          return show_page('doc_list', '文档列表');
        },
        cancel: function(button) {
          return alert('no');
        },
        confirmButton: "确定",
        cancelButton: "取消"
      });
    }
  });
});

this.doc_pull = function(doc_id) {
  $('#push-list').dataTable({
    "bRetrieve": true,
    "bDestroy": true,
    "oLanguage": {
      "sLengthMenu": "每页显示 _MENU_ 条记录",
      "sInfo": "从 _START_ 到 _END_ /共 _TOTAL_ 条数据",
      "sInfoEmpty": "&nbsp;",
      "sInfoFiltered": "(从 _MAX_ 条数据中检索)",
      "oPaginate": {
        "sFirst": "首页",
        "sPrevious": "前一页",
        "sNext": "后一页",
        "sLast": "尾页"
      },
      "sSearch": "搜索: ",
      "sZeroRecords": "没有检索到数据",
      "sProcessing": "<img src='./loading.gif' />"
    }
  });
  $("#push-list").dataTable().fnClearTable();
  return $.ajax({
    "type": "get",
    "url": "push/devices",
    "success": function(data) {
      var d, data_list, table_data, tmp, _i, _len;
      console.log(data);
      data_list = data['data'];
      table_data = [];
      for (_i = 0, _len = data_list.length; _i < _len; _i++) {
        d = data_list[_i];
        tmp = [];
        tmp.push('<input type="checkbox" name="check_list" value="' + d['did'] + '">');
        tmp.push(d['owner']);
        tmp.push(d['phone']);
        table_data.push(tmp);
      }
      $("#doc_id").val(doc_id);
      $("#push-list").dataTable().fnAddData(table_data);
      $('[data-rel=tooltip]').tooltip({
        'html': true
      });
    }
  });
};

this.doc_upload = function() {
  return $('#doc-upload-form').ajaxSubmit(function(data) {
    if (data.status === 1) {
      alert('上传成功');
    }
    $('#doc-upload').on('hidden.bs.modal', function() {
      return show_page('html_doc', '文档列表');
    });
    return $('#doc-upload').modal('hide');
  });
};

this.doc_delete = function(doc_id) {
  return root.doc_id = doc_id;
};

this.doc_push = function() {
  return $('#doc-push-form').ajaxSubmit(function(data) {
    if (data.status === 1) {
      alert('推送成功');
    }
    $('#push-list').on('hidden.bl.modal', function() {
      return show_page('doc_list', '推送文档');
    });
    return $('#push-list').modal('hide');
  });
};
