// Generated by CoffeeScript 1.7.1
var root;

root = typeof exports !== "undefined" && exports !== null ? exports : this;

this.update_user = function(uid) {
  return $.ajax({
    "type": "get",
    "url": "/user/user_info?uid=" + uid,
    "success": function(data) {
      return console.log(data);
    }
  });
};

this.device_add = function() {
  return $('#device-add-form').ajaxSubmit(function(data) {
    if (data.status === 1) {
      alert('添加成功');
    }
    $('#device-add').on('hidden.bs.modal', function() {
      return show_page('device_list', '设备');
    });
    return $('#device-add').modal('hide');
  });
};

this.device_enroll = function() {
  return $('#device-enroll-form').ajaxSubmit(function(data) {
    alert(data['token']);
    $('#device-enroll').on('hidden.bs.modal', function() {
      return show_page('device_list', '设备');
    });
    return $('#device-enroll').modal('hide');
  });
};

this.device_initial = function() {
  return $('#device-initial-form').ajaxSubmit(function(data) {
    alert(data['status']);
    $('#device-initial').on('hidden.bs.modal', function() {
      return show_page('device_list', '设备');
    });
    return $('#device-initial').modal('hide');
  });
};

this.msg_push = function() {
  return $('#msg-push-form').ajaxSubmit(function(data) {
    return alert(data);
  });
};

this.show_detail = function(did) {
  root.did = did;
  $('#msg_push_did').val(did);
  return $.ajax({
    "type": "get",
    "contentType": "application/json",
    "url": "/devices/" + did,
    "success": function(resp) {
      var data;
      data = resp.data;
      $('#loc_interval').html(data['loc_interval']);
      $('#loc_mode').html(data['loc_mode']);
      $('#did').html(data['did']);
      $('#cid').html(data['cid']);
      return $('#imei').html(data['imei']);
    }
  });
};

$(function() {
  $('#device-list').dataTable({
    "oLanguage": {
      "sLengthMenu": "每页显示 _MENU_ 条记录",
      "sInfo": "从 _START_ 到 _END_ /共 _TOTAL_ 条数据",
      "sInfoEmpty": "&nbsp;",
      "sInfoFiltered": "(从 _MAX_ 条数据中检索)",
      "oPaginate": {
        "sFirst": "首页",
        "sPrevious": "前一页",
        "sNext": "后一页",
        "sLast": "尾页"
      },
      "sSearch": "搜索: ",
      "sZeroRecords": "没有检索到数据",
      "sProcessing": "<img src='./loading.gif' />"
    }
  });
  $.ajax({
    "type": "get",
    "url": "devices",
    "success": function(data) {
      var d, data_list, table_data, tmp, _i, _len;
      console.log(data);
      data_list = data['data'];
      table_data = [];
      for (_i = 0, _len = data_list.length; _i < _len; _i++) {
        d = data_list[_i];
        tmp = [];
        tmp.push(d['owner']);
        tmp.push(d['phone']);
        tmp.push(d['time']);
        if (d.active === false) {
          tmp.push("<span class=\"btn btn-warning btn-xs tooltip-warning\" data-rel=\"tooltip\" data-placement=\"left\" data-original-title=\"tid:" + d.tid + "<br>激活码:" + d.active_code + "<br>手机号:" + d.phone + "\" style=\"width: 64px;\">未激活</span>");
        } else if (d.did != null) {
          tmp.push("<button type='button' class='btn btn-xs btn-success' data-toggle='modal' data-target='#device-detail' onclick='show_detail(\"" + d['did'] + "\")'>设备详情</button>");
        } else {
          tmp.push("<span class=\"btn btn-info btn-xs\" style=\"width: 64px;\">正在激活</span>");
        }
        table_data.push(tmp);
      }
      $("#device-list").dataTable().fnAddData(table_data);
      $('[data-rel=tooltip]').tooltip({
        'html': true
      });
    }
  });
  $('a[data-toggle="tab"]').on('shown.bs.tab', function(e) {
    if (e.target.outerText === 'Location') {
      return $.ajax({
        "type": "get",
        "contentType": "application/json",
        "url": "/loc/latest?did=" + root.did,
        "success": function(resp) {
          var map, marker, point;
          console.log(resp);
          map = new BMap.Map("allmap");
          point = new BMap.Point(resp.long, resp.lat);
          map.centerAndZoom(point, 15);
          marker = new BMap.Marker(point);
          map.addOverlay(marker);
          return marker.setAnimation(BMAP_ANIMATION_BOUNCE);
        }
      });
    }
  });
  $('a[data-toggle="tab"]').on('shown.bs.tab', function(e) {
    if (e.target.outerText === 'App') {
      return $.ajax({
        "type": "get",
        "contentType": "application/json",
        "url": "/app/list?did=" + root.did,
        "success": function(resp) {
          var app_list, d, table_data, tmp, _i, _len;
          console.log(resp);
          app_list = resp['data'];
          table_data = [];
          for (_i = 0, _len = app_list.length; _i < _len; _i++) {
            d = app_list[_i];
            tmp = [];
            tmp.push(d['appName']);
            tmp.push(d['appId']);
            tmp.push(d['version']);
            table_data.push(tmp);
          }
          return $("#device_app_list").dataTable().fnAddData(table_data);
        }
      });
    }
  });
  return $('#device_app_list').dataTable({
    "oLanguage": {
      "sLengthMenu": "每页显示 _MENU_ 条记录",
      "sInfo": "从 _START_ 到 _END_ /共 _TOTAL_ 条数据",
      "sInfoEmpty": "&nbsp;",
      "sInfoFiltered": "(从 _MAX_ 条数据中检索)",
      "oPaginate": {
        "sFirst": "首页",
        "sPrevious": "前一页",
        "sNext": "后一页",
        "sLast": "尾页"
      },
      "sSearch": "搜索: ",
      "sZeroRecords": "没有检索到数据",
      "sProcessing": "<img src='./loading.gif' />"
    }
  });
});
